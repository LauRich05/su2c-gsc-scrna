---
title: "Get Preprocessed Adult GBM Samples"
output: html_notebook
---

``` {r}
#####################################################################################################
############### Make Analysis Ready RNA-seq Data for all GBM Samples, coh1234 + nonSU2C ###########
#####################################################################################################

## OVERVIEW:  Make DESEQ2 dataset objects as well as vst transformed data for
##            all GBM samples. Note that there were large batch effects observed
##            previously with th nonSU2C samples, so I elect to perform batch correction
##            for nonSU2C status. note that for cohort 4 we only hav e1 sample, and 
##            from prior analyses, we see that cohort 4 is not strongly separated from
##            cohorts 1-3 in the space of RNA-seq data. The batch effects for nonSU2C
##            status were likely due to differences in sequencing depth as well as
##            individual who performed experiments, according to collaborators
##            involved in SU2C project (e.g. Florence Cavalli at Taylor Lab). Also note
##            that values for fpkm + vst cannot be directly compared to those produced when preprocessing adult GBM samples
##            alone, as pediatric samples are included
##
##          files used include: 
##              RNA_coh1234_nonSU2C_counts_SummExp.RData:
##              counts and metadata for RNA cohorts 1-4 + nonSU2C samples
##              exonic.gene.sizes_chr.RData:
##              exonic gene sizes for hg38, generated by Florence Cavalli
##          see associated README.txt files for respective directories if you want 
##          further information regarding data

#############################################################################################
print('BEGIN SCRIPT')
print(Sys.time())
### Load required packages + functions
library(readxl)
library(SummarizedExperiment)
library(DESeq2)
### Load in Data
# data_folder <- '../data_01_2018'
## setup directories
top_dir <- '~/projects/su2c_v2'
# ## metadata directory
# preproces_metadata_dir <- file.path(top_dir, 'data/preprocessed/metadata')
## directory to output preprocessed RNA data, and location of SummarizedExperimentObject
preprocess_RNA_dir <- file.path(top_dir, 'data/preprocessed/RNA')
stopifnot(dir.exists(preprocess_RNA_dir))
preprocess_RNA_coh1234 <- file.path(preprocess_RNA_dir, 'SU2C_coh1234_nonSU2C')
stopifnot(dir.exists(preprocess_RNA_coh1234))
## Load RNA SummarizedExperiment object
fname_RNA_SummExp <- 'RNA_coh1234_nonSU2C_counts_SummExp.RData'
load(file = file.path(preprocess_RNA_coh1234, fname_RNA_SummExp))
RNA_SummExp <- RNA_coh1234_nonSU2C_counts_SummExp
rm(RNA_coh1234_nonSU2C_counts_SummExp)
###############################################################################
### Subset for all GBM samples that aren't technical replicates
## recall that SampleID used corresponds to biological sample,
## Sample refers to a particular experiment performed. Not the best nomenclature,
## but changing metadata labels now may make things more confusing
## order by cohort 
RNA_SummExp <- RNA_SummExp[, order(RNA_SummExp$Cohort,
                                   RNA_SummExp$Type_bis,
                                   RNA_SummExp$SampleID_used)]
# unique(RNA_SummExp$Cohort)
# [1] "Cohort1" "Cohort2" "Cohort3" "Cohort4" "nonSU2C"
is.gbm <- RNA_SummExp$Tumor_type == 'GBM'
# unique(RNA_SummExp$Tumor_type)
# [1] "GBM"     "PFA"     "control"
is.tech.rep <- duplicated(RNA_SummExp$SampleID_used)
is.nonSU2C <- RNA_SummExp$Cohort == 'nonSU2C'
# remove G607 and G811 as 607 is improperly annotated as a GBM,
# G811 may be improperly annotated as a GBM. These samples 
# were not included in analysis as of Oct 2018 committee meeting
G811.or.G607 <- grepl('G607|G811', RNA_SummExp$SampleID_used)

## check that any duplicates in cohorts 1-4 are not in nonSU2C set
## (i.e. if there are duplicates between SU2C and nonSU2C set, 
## nonSU2C labeled as duplicate and will be removed)
SU2C_dups <- RNA_SummExp$SampleID_used[which(is.tech.rep & !is.nonSU2C)]
if(any(SU2C_dups %in% RNA_SummExp$SampleID_used[which(is.nonSU2C)])) {
  stop('expectation failed, expect that all samples listed as duplicate in
       cohorts 1-4 are not listed as duplicates of nonSU2C samples. If
       there are duplicate samples between coh1-4 and nonSU2C cohort,
       nonSU2C sample should be marked as duplicated')
}
## perform subsetting
RNA_GBM <- RNA_SummExp[,which(is.gbm & !is.tech.rep & !G811.or.G607)]
# dim(RNA_GBM)
# [1] 26475   132
#########################################################################
### Subset genes
## load in gene lengths
raw_RNA_dir <- file.path(top_dir, 'data/raw/RNA')
raw_coh123 <- file.path(raw_RNA_dir, 'RNA_florence_01_2018_SU2C_coh123')
load(file.path(raw_coh123, 'exonic.gene.sizes_chr.RData'))

exonic.gene.sizes <- as.numeric(exonic.gene.sizes_chr)
equiv.entries <- sapply(1:length(exonic.gene.sizes_chr), FUN = function(x) {
  exonic.gene.sizes[x] == exonic.gene.sizes_chr[[x]]
})
if(!all(equiv.entries)) {
  stop('expected the coercing exonic.gene.sizes_chr to numeric would preserve
       ordering, assumption failed')
}
names(exonic.gene.sizes) <- names(exonic.gene.sizes_chr)

common.genes <- intersect(rownames(RNA_GBM), names(exonic.gene.sizes))
# length(common.genes)
# [1] 26467
RNA_GBM <- RNA_GBM[rownames(RNA_GBM) %in% common.genes,]
exonic.gene.sizes <- exonic.gene.sizes[rownames(RNA_GBM)]
# dim(RNA_GBM)
# [1] 26467   132
rowData(RNA_GBM)$basepairs <- exonic.gene.sizes
## remove genes with less than 5 counts across all samples
RNA_GBM <- RNA_GBM[which(apply(assay(RNA_GBM), 
                                           MARGIN = 1, 
                                           FUN = sum) 
                                     >= 5),]
# dim(RNA_GBM)
# [1] 24737   132
#########################################################################
### Make DESEQ2 object and get fpkm values and vst transform
print('==============================================')
print('making DESEQ2 object for non-SU2C data, getting fpkm values, vst transform')


## make DESEQ2 dataset object
RNA_GBM_dds <- DESeqDataSet(se = RNA_GBM,
                                  design = ~1)

RNA_GBM_dds <- estimateSizeFactors(RNA_GBM_dds)
fname <- 'RNA_GBM_dds.rds'
saveRDS(RNA_GBM_dds, file = file.path(preprocess_RNA_coh1234, fname))
## create nonSU2C status as a factor for Combat and DESEQ2's models
colData(RNA_GBM_dds)$is.nonSU2C <- colData(RNA_GBM_dds)$Cohort == 'nonSU2C'
## set all categorical values to be used in modeling to factors
colData(RNA_GBM_dds)$is.nonSU2C <- factor(colData(RNA_GBM_dds)$is.nonSU2C )
colData(RNA_GBM_dds)$Type_bis <- factor(colData(RNA_GBM_dds)$Type_bis)
colData(RNA_GBM_dds)$Lab <- factor(colData(RNA_GBM_dds)$Lab)
colData(RNA_GBM_dds)$Sex <- factor(colData(RNA_GBM_dds)$Sex)
colData(RNA_GBM_dds)$Primary_recurrent <- factor(colData(RNA_GBM_dds)$Primary_recurrent)
## make model matrix for covariates of interest for batch correction
covariate_formula <- formula('~ Type_bis + Lab + Sex + Age_group + Primary_recurrent')
mod_frame <- model.frame(data = colData(RNA_GBM_dds), 
                         formula = covariate_formula)
mod_mat <- model.matrix(object = covariate_formula, data = mod_frame)
## get fpkm values, saveRDS as SummarizedExperiment objects
# no batch correction
# we also set all zero values to minimum fpkm value so that batch correction doesn't deal with missing values
# (log2 transform needs to not evaluate to infinity for batch correction to work)
RNA_GBM_fpkm <- DESeq2::fpkm(object = RNA_GBM_dds, 
                                   robust = T)
non_zero_ind <- which(RNA_GBM_fpkm > 0)
non_zero_vals <- RNA_GBM_fpkm[non_zero_ind]
floor <- min(non_zero_vals)
RNA_GBM_fpkm[RNA_GBM_fpkm == 0] <- floor
if (!all(RNA_GBM_fpkm[non_zero_ind] == non_zero_vals))
{
  stop('mislabeling of values in fpkm matrix prior to batch correction')
}
RNA_GBM_fpkm <- SummarizedExperiment(assays = list(fpkm = RNA_GBM_fpkm),
                                           colData= colData(RNA_GBM_dds))
fname2 <- 'RNA_GBM_fpkm.rds'
saveRDS(RNA_GBM_fpkm, file = file.path(preprocess_RNA_coh1234, fname2))

# batch forrected fpkm for nonSU2C status
RNA_GBM_fpkm_combat_nonSU2C <- 2^(sva::ComBat(dat = log2(assay(RNA_GBM_fpkm, 1)), 
                                                    batch = colData(RNA_GBM_dds)$is.nonSU2C,
                                                    mod = mod_mat))
RNA_GBM_fpkm_combat_nonSU2C <- SummarizedExperiment(assays = list(fpkm = RNA_GBM_fpkm_combat_nonSU2C),
                                                          colData = colData(RNA_GBM_dds))
fname2.2 <- 'RNA_GBM_fpkm_combat_nonSU2C.rds'
saveRDS(RNA_GBM_fpkm_combat_nonSU2C, file = file.path(preprocess_RNA_coh1234, fname2.2))

## get vst transform
RNA_GBM_vst <- vst(RNA_GBM_dds)
fname3 <- 'RNA_GBM_vst.rds'
saveRDS(RNA_GBM_vst, file = file.path(preprocess_RNA_coh1234, fname3))

## batch correct for nonSU2C status
RNA_GBM_vst_combat_nonSU2C <- RNA_GBM_vst
assay(RNA_GBM_vst_combat_nonSU2C) <- sva::ComBat(dat = assay(RNA_GBM_vst_combat_nonSU2C, 1), 
                                                              batch = colData(RNA_GBM_vst_combat_nonSU2C)$is.nonSU2C,
                                                              mod = mod_mat)
fname_3.2 <- 'RNA_GBM_vst_combat_nonSU2C.rds'
saveRDS(RNA_GBM_vst_combat_nonSU2C, file = file.path(preprocess_RNA_coh1234, fname_3.2))
print('END SCRIPT')
print(Sys.time())
print(sessionInfo())
```