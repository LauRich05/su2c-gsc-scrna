---
title: "Preprocess RNA data for coh1234 + nonSU2C"
output: html_notebook
---


``` {r}
#####################################################################################################
############### PREPROCESSING OF SU2C cohorts 1-4 and NON-SU2C RNA_seq DATA TOGETHER ################
#####################################################################################################

## OVERVIEW:  Make SummarizedExperiment object for coh1234 + nonSU2C samples.
##
##          files used include: M_count_cohort1_2_3_nonSU2C.RData: 
##                              raw read count for all SU2C (cohorts 1-3) and 
##                              non SU2C samples
##                              M_count_info_cohort4.RData: raw read count for SU2C
##                              mini cohort 4 (processed separately from 
##                              cohorts 1-3) + metadata for SU2C mini cohort 4
##                              sample_meta_coh1234_nonSU2C.RData:
##                              sample metadata for all samples in cohorts 1-4 + nonSU2C
##                              
##          see associated README.txt files for respective directories if you want 
##          further information regarding data

#############################################################################################
print('BEGIN SCRIPT')
print(Sys.time())
### Load required packages + functions
require(readxl)
require(SummarizedExperiment)
### Load in Data
# data_folder <- '../data_01_2018'
## setup directories
top_dir <- '~/projects/su2c_v2/'
## raw data directories
raw_RNA_dir <- file.path(top_dir, 'data/raw/RNA')
raw_coh123_nonSU2C <- file.path(raw_RNA_dir, 
                                'RNA_florence_06_2018_SU2C_coh123_nonSU2C')
raw_coh4 <- file.path(raw_RNA_dir,
                          'RNA_florence_07_2018_SU2C_cohort4')
## metadata directory
preproces_metadata_dir <- file.path(top_dir, 'data/preprocessed/metadata')
## directory to output preprocessed RNA data
preprocess_RNA_dir <- file.path(top_dir, 'data/preprocessed/RNA')
if (!dir.exists(preprocess_RNA_dir))
{
  dir.create(preprocess_RNA_dir)
}
preprocess_RNA_coh1234 <- file.path(preprocess_RNA_dir, 'SU2C_coh1234_nonSU2C')
if (!dir.exists(preprocess_RNA_coh1234))
{
  dir.create(preprocess_RNA_coh1234)
}
## load in files
RNA_count_mat_file <- 'M_count_cohort1_2_3_nonSU2C.RData'
RNA_count_meta_cohort_4_file <- 'M_count_info_cohort4_GBM.RData'
sample_meta_file <- 'sample_meta_coh1234_nonSU2C.RData'
load(file.path(raw_coh123_nonSU2C, RNA_count_mat_file))
load(file.path(raw_coh4, RNA_count_meta_cohort_4_file))
load(file.path(preproces_metadata_dir, sample_meta_file))
## check dimensions of count matrices and metadata
print('dimensions (genes x samples) of coh123_nonSU2C RNA count matrix')
dim(M_count_cohort1_2_3_nonSU2C)
# [1] 26475   189
# note that patient ids are all unique in patient metatdata
# any(duplicated(M_samples$Patient_ID))
# [1] FALSE
print('dimensions (genes x samples) of cohort 4 RNA count matrix')
dim(M_count_cohort4_GBM)
# [1] 26475     4

###############################################################################
### Merge cohort 1 and cohort 4 count matrices
## note that G837 is only sample from 'cohort 4' in our metadata
head(M_count_cohort4_GBM)
# A92172_G938_line A92182_G938_cortex A92188_G837_line A92190_G938_tissue
# DDX11L1                  0                  0                1                  0
# WASH7P                 220                160              355                286
# MIR6859-3                0                  0                0                  0
# MIR6859-2                0                  0                0                  0
# MIR6859-1                0                  0                0                  0
# MIR6859-4                0                  0                0                  0
head(sample_meta_coh1234_nonSU2C[sample_meta_coh1234_nonSU2C$Cohort == 'Cohort4',])
# Sample    Lib   Lab Patient Type_init Type_bis Patient_used_id SampleID_used Tumor_type
# A92188_G837_line A92188 Dirks    G837      line        L            G837        G837_L        GBM
# Cohort Type condition Age Age_group Primary_recurrent Primary_for_recurrent  Sex
# Cohort4 Line      <NA>  66     adult           primary                    NA Male
## use only G837 from cohort 4 since according to Florence it's the only adult GBM line
## in cohort 4
G837_count <- M_count_cohort4_GBM[, grep('G837', colnames(M_count_cohort4_GBM))]
head(G837_count)
cond1 <- all(names(G837_count) == rownames(M_count_cohort4_GBM))
# [1] TRUE
cond2 <- all(G837_count == M_count_cohort4_GBM[, grep('G837', colnames(M_count_cohort4_GBM))])
# [1] TRUE
# DDX11L1    WASH7P MIR6859-3 MIR6859-2 MIR6859-1 MIR6859-4 
# 1       355         0         0         0         0 
if (! (cond1 && cond2)) {
  stop('subsetting done improperly for G837 expression values')
} else {
  rm(cond1)
  rm(cond2)
}
## merge count matrices
if (!all(names(G837_count) == rownames(M_count_cohort1_2_3_nonSU2C))) {
  stop('expected common gene names between cohort 4 matrix and coh123 + nonSU2C matrix')
} else {
  M_count_coh1234_nonSU2C <- M_count_cohort1_2_3_nonSU2C
  M_count_coh1234_nonSU2C <- cbind(M_count_coh1234_nonSU2C, G837_count)
  # tail(colnames(M_count_coh1234_nonSU2C))
  # [1] "G571_L"     "G613_L"     "G648_L"     "G705_L"     "G744_L"     "G837_count"
  colnames(M_count_coh1234_nonSU2C)[ncol(M_count_coh1234_nonSU2C)] <- 'A92188_G837_line'
}
###############################################################################
### Make SummarizedExperiment object
## subset for samples that are in metadata
dim(M_count_coh1234_nonSU2C)
# [1] 26475   190
common_samples <- intersect(sample_meta_coh1234_nonSU2C$Sample,
                            colnames(M_count_coh1234_nonSU2C))
# length(common_samples)
# [1] 186
# colnames(M_count_coh1234_nonSU2C)[which(!colnames(M_count_coh1234_nonSU2C) 
#                                         %in% common_samples)]
# [1] "A61511_Control_BT1998001" "A61515_Control_BT2010114" "A61533_Control_TL3Adult" 
# [4] "A61548_Control_TL1Adult" 
# all(rownames(sample_meta_coh1234_nonSU2C) == sample_meta_coh1234_nonSU2C$Sample)
# any(duplicated(sample_meta_coh1234_nonSU2C$Sample))
# [1] FALSE
rownames(sample_meta_coh1234_nonSU2C) <- sample_meta_coh1234_nonSU2C$Sample
M_count_coh1234_nonSU2C <- M_count_coh1234_nonSU2C[,common_samples]
sample_meta_coh1234_nonSU2C <- sample_meta_coh1234_nonSU2C[common_samples,]
RNA_coh1234_nonSU2C_counts_SummExp <- SummarizedExperiment(assays = list(counts = M_count_coh1234_nonSU2C),
                                                          colData = DataFrame(sample_meta_coh1234_nonSU2C))
fname_summ_expt_full <- 'RNA_coh1234_nonSU2C_counts_SummExp.RData'
save(RNA_coh1234_nonSU2C_counts_SummExp, file = file.path(preprocess_RNA_coh1234,
                                                          fname_summ_expt_full))

print('END SCRIPT')
print(Sys.time())
print(sessionInfo())
```