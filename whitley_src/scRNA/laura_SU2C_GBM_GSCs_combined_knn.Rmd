---
title: "Run KNN to Distinguish Btw Tumour + Line"
output:
  html_document:
    df_print: paged
    toc: true
    toc_depth: 5
params:
  inp_data: '/home/owenwhitley/projects/su2c_v2/data/preprocessed/scRNA/GSCs_Tumour_combined/laura_BTSC_Tumour_combined_Oct_2019_no_G800_L.rds'
  results_dir: '/home/owenwhitley/projects/su2c_v2/results/scRNA/laura_SU2C_GSCs_GBM_combined_Oct_2019_no_G800_L_knn'
  rerun_knn: TRUE
  n_splits: 10
  split_fraction: 0.20
  base_seed: 12345
  file_prefix: 'knn_classifier_T_v_L'
  num_dims: 2
  other_reductions_plot: 'pca'
  dims_use_mapping: 'NULL'
  reduction_use: 'pca'
  feats_plot: 'NULL'
  barchart_fontsize: 15.0
---
# Overview

Here we are interested in seeing if tumour and line cells are linearly separable in PCA space and will
be training a logistic regression classifier to see if this is the case. We will examine which PCs
the classifier considers important, and see what genes are associated with said PCs.

# Setup

``` {r}
suppressPackageStartupMessages({
  library(ComplexHeatmap)
  source('./laura_SU2C_GBM_GSCs_combined_explore_helpers.R')
})
for (i in 1:length(params)) {
  param.i <- names(params)[i]
  assign(param.i, params[[i]])
  if (param.i == 'inp_data') {
    if (is.character(inp_data)) {
      # we only load data in from file for testing/debugging purposes.
      # inp_data should generally be a Seurat object that is fully preprocessed 
      # as outlined in 'seurat_pipeline' function in helper functions,
      # with PCA calculated
      if (file.exists(inp_data)) {
        inp_data <- readRDS(inp_data)
      } else {
        stop('file does not exist')
      }
    }
  }
}
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}
other_reductions_plot <- setdiff(other_reductions_plot, reduction_use)

# not current run options
run_opts_curr <- params[c('n_splits', 'split_fraction', 'base_seed', 'file_prefix')]
results_file <- paste0(file_prefix, '.pydata')
run_opts_file <- paste0(file_prefix, '_run_opts.rds')

# setup mapping of dim reduction names to dims to use for each dim reduction in 'other_reductions
if (dims_use_mapping == 'NULL') {
  # dims_use_mapping should be a named list of lists, with each 'sublist' containing pairs of 
  # dimensions to plot
  dims_use_mapping <- list(pca = list(c(1,2), c(1,3)),
                           tsne = list(c(1,2)),
                           harmony = list(c(1,2)),
                           mnn = list(c(1,2)),
                           fastmnn = list(c(1,2), c(2,3)))
} else {
  if (!is.list(dims_use_mapping)) {
    stop('dims_use_mapping, if specified, must be a list')
  }
}
if (!all(other_reductions_plot %in% names(dims_use_mapping))) {
  stop('all reductions plotted must be in names of dim_use_mapping')
}
# decide whether or not we will be plotting feature loadings for pca. may change in future to accomodate mnn/fastmnn loadings
use_pca <- 'pca' == reduction_use

# specify features to plot if left unspecified
if (feats_plot == 'NULL') {
  feats_plot <- c('culture_cond', 'pred_class', 'misclassified', 'C1_C2_diff')
}

```

# Computations

```{r}

if (!file.exists(file.path(results_dir, results_file)) || rerun_knn) {
  # see if there are any PCs that can separate tumour + line
  T_v_L_knn <- fit_knn_cv_multi(X = Seurat::GetCellEmbeddings(inp_data, reduction.type = reduction_use)[,1:num_dims],
                               y = as.integer(inp_data@meta.data$SampleType == 'Tumour'),
                               num_splits = n_splits, 
                               split_fraction = split_fraction, 
                               base_seed = base_seed,
                               k_vals = 3:50)
  # save run options
  run_opts_prev <- run_opts_curr
  reticulate::py_save_object(T_v_L_knn, file = file.path(results_dir, results_file))
  saveRDS(run_opts_prev, file = file.path(results_dir, run_opts_file))
} else {
  T_v_L_knn <- reticulate::py_load_object(file.path(results_dir, results_file))
  run_opts_prev <- readRDS(file.path(results_dir, run_opts_file))
  if (!identical(run_opts_prev, run_opts_curr)) {
    warning(run_opts_prev)
    stop('previous run options not identical to current run options. \
         reset run options to previous values or set rerun_knn to TRUE')
  }
}

gc(full = TRUE)
  
```

# View Results

``` {r}
boxplot(list(T_v_L_knn$train_accuracy_vals,
             T_v_L_knn$test_accuracy_vals),
        names = c('train accuracy', 'test accuracy'),
        main = paste('Train and Test Accuracy for KNN classifier,', n_splits, 'splits'))


# k-values
T_v_L_knn$k_vals

boxplot(T_v_L_knn$k_vals)

# selected k-value for output model
T_v_L_knn$final_model$k
```



## Visualize Where Predicted Classes Occur on Dim Red Plots

### Make Predictions and Label Misclassified Cells

``` {r}
cell_embeddings <- Seurat::GetCellEmbeddings(inp_data, reduction.type = reduction_use)[,1:num_dims]
pred_class <- T_v_L_knn$final_model$model$predict(cell_embeddings)
inp_data@meta.data$pred_class <- ifelse(pred_class == 1, 'Tumour', 'Line')
inp_data@meta.data$misclassified <- inp_data@meta.data$pred_class != inp_data@meta.data$SampleType
saveRDS(inp_data, file = file.path(results_dir, paste0(file_prefix, '_seurat.rds')))
```

### Imput Embedding Space Plots

``` {r}
try({
  for (i in 1:(num_dims - 1)) {
    j <- i + 1
    make_dr_plots(inp_data, dim1 = i, dim2 = j,
                  feats_plot = feats_plot, reduction.use = reduction_use, legend_pt_size = 5)
    cat('**Misclassified Cells Only**\n')
    make_dr_plots(inp_data, dim1 = i, dim2 = j,
                  feats_plot = feats_plot, reduction.use = reduction_use,
                  filter_by = 'misclassified', filter_class = 'TRUE',
                  legend_pt_size = 5)
  }
})



```

### other reductions to use

``` {r, results='asis'}
for (dr_name in other_reductions_plot) {
  dr_name_upper <- toupper(dr_name)
  cat(paste('####', dr_name_upper, '\n'))
  dims_use_list <- dims_use_mapping[[dr_name]]
  
  for (i in 1:length(dims_use_list)) {
    dims_i <- dims_use_list[[i]]
    cat(paste('#####', paste(dr_name_upper, dims_i[1]), paste(dr_name_upper, dims_i[2]), '\n'))
    try({
      make_dr_plots(inp_data, dim1 = dims_i[1], dim2 = dims_i[2], 
                      feats_plot = feats_plot, reduction.use = dr_name, legend_pt_size = 5)
      cat('**Misclassified Cells Only**\n')
      make_dr_plots(inp_data, dim1 = dims_i[1], dim2 = dims_i[2], 
                        feats_plot = feats_plot, reduction.use = dr_name,
                    filter_by = 'misclassified', filter_class = 'TRUE', legend_pt_size = 5)
    })
    cat('\n')
    cat('\n')
  }
}

```


## Assess Proportions of Tumour + Line Cells in Misclassified Cells

``` {r, error=TRUE}

stacked_barcharts(inp_data = inp_data@meta.data, split_by = 'misclassified', color_by = 'SampleType')
stacked_barcharts(inp_data = inp_data@meta.data, split_by = 'misclassified', color_by = 'SampleType', show_proportion = TRUE)
stacked_barcharts(inp_data = inp_data@meta.data, split_by = 'SampleType', color_by = 'misclassified')
stacked_barcharts(inp_data = inp_data@meta.data, split_by = 'SampleType', color_by = 'misclassified', show_proportion = TRUE)

# make table displaying misclassified cells by SampleType (Tumour or Line)
sampletype_vs_misclassified <- make_table(inp_data@meta.data, var1 = 'SampleType', var2 = 'misclassified')
sampletype_vs_misclassified
write.csv(sampletype_vs_misclassified, file = file.path(results_dir, paste0(file_prefix, '_sampletype_vs_misclassified.csv')))

# show misclassified cells by Sample ID
# tumours
p <- stacked_barcharts(inp_data = inp_data@meta.data[inp_data@meta.data$SampleType == 'Tumour',], 
                       split_by = 'SampleID', color_by = 'misclassified', show_proportion = FALSE)
p <- p + theme(axis.text.x = element_text(angle = 90, size = barchart_fontsize))
print(p)
p <- stacked_barcharts(inp_data = inp_data@meta.data[inp_data@meta.data$SampleType == 'Tumour',], 
                       split_by = 'SampleID', color_by = 'misclassified', show_proportion = TRUE)
p <- p + theme(axis.text.x = element_text(angle = 90, size = barchart_fontsize))
print(p)

# lines
p <- stacked_barcharts(inp_data = inp_data@meta.data[inp_data@meta.data$SampleType == 'Line',], 
                       split_by = 'SampleID', color_by = 'misclassified', show_proportion = FALSE)
p <- p + theme(axis.text.x = element_text(angle = 90, size = barchart_fontsize))
print(p)
p <- stacked_barcharts(inp_data = inp_data@meta.data[inp_data@meta.data$SampleType == 'Line',], 
                       split_by = 'SampleID', color_by = 'misclassified', show_proportion = TRUE)
p <- p + theme(axis.text.x = element_text(angle = 90, size = barchart_fontsize))
print(p)
# make tables showing same info
SampleID_vs_misclassified <- make_table(inp_data@meta.data, var1 = 'SampleID', var2 = 'misclassified', filter_by = NULL, filter_class = NULL)
# order by tumour/line status
SampleID_vs_misclassified <- SampleID_vs_misclassified[order(grepl('_T', rownames(SampleID_vs_misclassified))),]
SampleID_vs_misclassified
write.csv(SampleID_vs_misclassified, file = file.path(results_dir, paste0(file_prefix, '_SampleID_vs_misclassified.csv')))
write.csv(SampleID_vs_misclassified, file = file.path(results_dir, paste0(file_prefix, '_SampleID_vs_misclassified.csv')))


```

# SessionInfo

``` {r}
Sys.time()
sessionInfo()
```

